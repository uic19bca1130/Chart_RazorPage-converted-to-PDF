@page
@using static Chart_RazorP.Models.Employee;

@model Chart_RazorP.Pages.IndexModel;
@{
	ViewData["Title"] = "Home page";
	var name = Model.employee[0].Name;
}

<style>
	/* Add tooltip style */
	.tooltip {
		position: absolute;
		background-color: white;
		border: 1px solid #ccc;
		padding: 8px;
		opacity: 0;
		pointer-events: none;
	}
</style>
<style>
	.blue-box {
		background-color: black;
		color: white;
		padding: 10px;
		border-radius: 5px;
	}

	body {
		position: relative;
		height: 100vh; /* Set the body height to the full viewport height */
		margin: 0; /* Remove default margin */
	}

	#blurry-background {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 255, 0.3); /* Bluerish background color with transparency */
		backdrop-filter: blur(10px); /* Apply blur effect */
		z-index: -1; /* Place it behind other content */
	}

	#watermark {
		position: absolute;
		top: 50%; /* Position the text vertically in the center of the page */
		left: 50%; /* Position the text horizontally in the center of the page */
		transform: translate(-50%, -50%); /* Center both horizontally and vertically */
		font-size: 100px;
		color: white; /* Text color */
		opacity: 0.5; /* Adjust opacity for a subtle effect */
		font-weight: bold;
	}

	.btn-3d {
		background-color: #007bff; /* Blue color, you can change this */
		color: white;
		border: none;
		padding: 12px 24px;
		border-radius: 5px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		transition: transform 0.2s;
	}

		/* Add hover effect for the 3D button */
		.btn-3d:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
		}
</style>

<div id="pdfContent">
	<div class="col-sm-6">
		<div class="row">
			<div class="blue-box">
				<div class="card-header">
					📚📚Generate PDF reports that dynamically showcase your data using bar charts, line charts, 👇pie charts, and tables data👇.
				</div>
				<div class="card-body">
					<canvas class="" id="bar" style="display:none;"> </canvas>
				</div>

				<div class="row mt-3">
					<div class="col">
						<button id="exportToPdfBtn" class="btn btn-3d btn-primary">EXPORT TO PDF</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Add the watermark image -->
	<div class="col-sm-6">
		<div class="row">
			<img src="/images/downloadPDF.png" style="opacity:10%; width:70%;" alt="Watermark" />
		</div>
	</div>


	<div class="col-sm-6">
		<div class="row">
			@*<div class="card-header">
			line chart
			</div>*@
			<div class="card-body">
				<canvas class="mt-5" id="line" style="display:none;"></canvas>
			</div>
			<div class="card-body">
				<svg id="lineChart" style="display:none;"></svg>
			</div>
		</div>
	</div>
	<div class="col-sm-6 mt-4">
		<img id="pieChartImage" src="/images/piechart.png" alt="Your Image Description" height="320" width="350" style="display:none;" />
	</div>
</div>
<!-- Blur background div -->
<div id="blurry-background"></div>

<!-- Watermark text -->
<div id="watermark">PDF MAKER</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>  @*tool tip*@
<script src="https://d3js.org/d3.v7.min.js"></script>  @*SVG Line chart UI visibility*@
<!-- Include jsPDF library -->

<script type="text/javascript">

	var empName = [];
	var empSalary = [];

	@foreach (var employee in Model.employee)
	{
		<text>
			empName.push('@employee.Name');
		empSalary.push('@employee.Salary');
		</text>
	}

		barchart = document.getElementById('bar');  //document.getElementById('bar').getContext('2d');
	debugger
	console.log(barchart);
	new Chart(barchart, {
		type: 'bar',
		data: {
			labels: empName,
			borderColor: "#fffff",
			datasets: [{
				label: 'Salary',
				data: empSalary,
				backgroundColor: ['rgba(6,120,220)', 'rgba(6,120,150)', 'rgba(6,120,80)', 'rgba(6,50,80)'
				]
			}]
		},
		options: {
			scales: {
				yAxes: [{
					ticks: {
						beginAtZero: true
					}
				}]
			}
		}
	})

	//code for creating line chart using chart

	var linechart = document.getElementById('line');
	debugger;
	var mybarchart = new Chart(linechart, {
		type: 'line',
		data: {
			labels: empName,
			borderColor: "#fffff",
			lineTension: 0,
			datasets: [{
				fill: false,
				label: 'Salary',
				data: empSalary,
				backgroundColor: ['rgba(6,120,220)', 'rgba(6,120,150)', 'rgba(6,120,80)', 'rgba(6,50,80)'
				]
			}]
		},
		options: {
			scales: {
				yAxes: [{
					ticks: {
						beginAtZero: true,
					}
				}]
			}
		}
	})

	var margin = { top: 20, right: 20, bottom: 30, left: 50 };
	var width = 600 - margin.left - margin.right;
	var height = 400 - margin.top - margin.bottom;

	// Create an SVG element
	var svg = d3.select("#lineChart")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	// Create scales
	var x = d3.scaleBand()
		.domain(empName)
		.range([0, width])
		.padding(0.1);

	var y = d3.scaleLinear()
		.domain([0, d3.max(empSalary)])
		.range([height, 0]);

	// Create and draw the line chart
	var line = d3.line()
		.defined(function (d) { return d !== null; }) // Add this line to ignore null values
		.x(function (d, i) { return x(empName[i]) + x.bandwidth() / 2; })
		.y(function (d) { return y(d); });

	svg.append("path")
		.datum(empSalary)
		.attr("class", "line")
		.attr("d", line)
		.attr("fill", "none") // Set fill to none to remove fill color
		.attr("stroke", "green") // Set stroke color to green
		.attr("stroke-width", 2);

	// Add circles for each data point with tooltips
	var tooltip = d3.select("body")
		.append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);

	svg.selectAll(".dot")
		.data(empSalary)
		.enter().append("circle")
		.attr("class", "dot")
		.attr("cx", function (d, i) { return x(empName[i]) + x.bandwidth() / 2; })
		.attr("cy", function (d) { return y(d); })
		.attr("r", 4)
		.attr("fill", "green")
		.on("mouseover", function (d, i) {
			tooltip.transition()
				.duration(200)
				.style("opacity", 0.9);
			tooltip.html("Salary " + i)
				.style("left", (d.pageX) + "px")
				.style("top", (d.pageY - 28) + "px");
		})
		.on("mouseout", function () {
			tooltip.transition()
				.duration(500)
				.style("opacity", 0);
		});

	// Add x-axis
	svg.append("g")
		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x));

	// Add y-axis
	svg.append("g")
		.call(d3.axisLeft(y));

	// Add horizontal grid lines
	svg.append("g")
		.attr("class", "grid")
		.call(d3.axisLeft(y)
			.tickSize(-width)
			.tickFormat("")
		)
		.selectAll(".tick line")
		.attr("opacity", 0.3);

	// Add vertical grid lines
	svg.append("g")
		.attr("class", "grid-x")
		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x)
			.tickSize(-height)
			.tickFormat("")
		)
		.selectAll(".tick line")
		.attr("opacity", 0.3);

	document.getElementById("exportToPdfBtn").addEventListener("click", async function () {
		// Bar Chart Canvas
		debugger;
		const barCanvas = document.getElementById('bar');
		const canvasbar = document.createElement('canvas');
		const contextbar = canvasbar.getContext('2d');
		const widthbar = 640;
		const heightbar = 320;
		canvasbar.width = widthbar;
		canvasbar.height = heightbar;
		//const barcanvasimage = await html2canvas(barcanvas);
		contextbar.drawImage(barCanvas, 0, 0, widthbar, heightbar);
		const barCanvasImageData = canvasbar.toDataURL('image/png');

		const LineChartCanvas = document.getElementById('line');
		const canvasLineChart = document.createElement('canvas');
		const contextLineChart = canvasLineChart.getContext('2d');
		const widthLineChart = 640;
		const heightLineChart = 320;
		canvasLineChart.width = widthLineChart;
		canvasLineChart.height = heightLineChart;
		//const barcanvasimage = await html2canvas(barcanvas);
		contextLineChart.drawImage(LineChartCanvas, 0, 0, widthLineChart, heightLineChart);
		const LineChartCanvasImageData = canvasLineChart.toDataURL('image/png');

		const pieCanvas = document.getElementById('pieChartImage');
		// Create an HTMLCanvasElement to hold the image data
		const canvas1 = document.createElement('canvas');
		const context1 = canvas1.getContext('2d');
		const width1 = 350;
		const height1 = 320;
		canvas1.width = width1;
		canvas1.height = height1;
		// Draw the image onto the canvas
		context1.drawImage(pieCanvas, 0, 0, width1, height1);
		// Get the data URL of the canvas
		const pieCanvasImageData = canvas1.toDataURL('image/png');

		// Line Chart Canvas
		const lineChart = document.getElementById('lineChart');
		const canvas = document.createElement('canvas');
		const context = canvas.getContext('2d');
		const scaleFactor = 4;
		const width = 400 * scaleFactor;
		const height = 150 * scaleFactor;
		canvas.width = width;
		canvas.height = height;

		const svgString = new XMLSerializer().serializeToString(lineChart);
		const DOMURL = self.URL || self.webkitURL || self;
		const img = new Image();
		const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
		const url = DOMURL.createObjectURL(svgBlob);

		img.onload = function () {
			context.drawImage(img, 0, 0, width, height);
			// Get the data URL of the canvas

			const lineChartImageData = canvas.toDataURL('image/png');

			// Create PDF
			const pdf = new jsPDF();
			const imgWidth = 170;
			const imgHeight = 85;
			const headingCenter = (210 / 2) - 5

			pdf.setFillColor(6, 120, 220);  // Blue color
			pdf.rect(10, 14, 190, 7, 'F');  // Rectangle for the blue box

			// Add text inside the blue box at the top of the page
			pdf.setFontSize(12); // Adjust the font size
			pdf.setTextColor(255); // White text color
			pdf.text("Bar Chart", headingCenter, 19, { align: 'center' }); //Adjust the vertical position

			// Add title to the first page
			//Line chart
			pdf.setFillColor(6, 120, 220); // Blue color
			pdf.rect(10, imgHeight + 10, 190, 7, 'F');

			// Add text inside the blue box for the line chart
			pdf.setFontSize(12);
			pdf.setTextColor(255); // White text color
			pdf.text("Line Chart", headingCenter, imgHeight + 16, { align: 'center' });

			// Rectangle for the blue box at the top of the page


			pdf.setFillColor(6, 120, 220); // Blue color
			pdf.rect(10, imgHeight + 110, 190, 7, 'F'); // Rectangle for the blue box

			// Add text inside the blue box
			pdf.setFontSize(12);
			pdf.setTextColor(255); // White text color

			pdf.text("Pie Chart", headingCenter, imgHeight + 115, { align: 'center' });

			pdf.addImage(barCanvasImageData, 'PNG', 30, 25, imgWidth - 30, imgHeight - 20);
			pdf.addImage(LineChartCanvasImageData, 'PNG', 30, imgHeight + 20, imgWidth - 15, imgHeight);
			//or
			//pdf.addImage(lineChartImageData, 'PNG', 30, imgHeight + 20, imgWidth - 15, imgHeight);
			pdf.addImage(pieCanvasImageData, 'PNG', 50, imgHeight + 120, imgWidth - 75, imgHeight);

			pdf.addPage();

			// Table Data
			const tableData = [
				[1, 'sidhu', '123-456-7890', 'sidhu@example.com', 'test'],
				[2, 'mooseala', '987-654-3210', 'mooseala@example.com', 'test'],
				[3, 'mooseala', '987-654-3210', 'mooseala@example.com', 'test'],
				[4, 'mooseala', '987-654-3210', 'mooseala@example.com', 'test'],
			];
			const head = [['ID', 'Name', 'Phone', 'Email', 'Test']];
			const body = tableData;
			pdf.autoTable({
				head: head,
				body: body,
				theme: 'grid',
				headStyles: { fillColor: [6, 120, 220], textColor: 255 },
				styles: { textColor: [44, 62, 80] },
			});

			pdf.save("exported-charts.pdf");
		};
		img.src = url;
	});


</script>